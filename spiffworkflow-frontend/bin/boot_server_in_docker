#!/usr/bin/env bash

function error_handler() {
  echo >&2 "Exited with BAD EXIT CODE '${2}' in ${0} script at line: ${1}."
  exit "$2"
}
trap 'error_handler ${LINENO} $?' ERR
set -o errtrace -o errexit -o nounset -o pipefail

# sort of like https://lithic.tech/blog/2020-05/react-dynamic-config, but without golang
react_configs=$(env | grep -E "^SPIFFWORKFLOW_FRONTEND_RUNTIME_CONFIG_" || echo '')
if [[ -n "$react_configs" ]]; then
  index_html_file="/usr/share/nginx/html/index.html"
  if [[ ! -f "$index_html_file" ]]; then
    echo >&2 "ERROR: Could not find '${index_html_file}'. Cannot use SPIFFWORKFLOW_FRONTEND_RUNTIME_CONFIG values without it."
    exit 1
  fi

  if ! command -v sed >/dev/null; then
    echo >&2 "ERROR: sed command not found. Cannot use SPIFFWORKFLOW_FRONTEND_RUNTIME_CONFIG values without it."
    exit 1
  fi

  while IFS= read -r react_config; do
    [[ -z "$react_config" ]] && continue

    env_var=$(awk -F '=' '{print $1}' <<<"$react_config" | sed -E 's/^SPIFFWORKFLOW_FRONTEND_RUNTIME_CONFIG_//')
    env_value=$(awk -F '=' '{print $2}' <<<"$react_config" | sed -E "s/(^['\"]|['\"]$)//g")

    if [[ -z "$env_var" ]]; then
      echo >&2 "ERROR: Could not parse react config line: '${react_config}'."
      exit 1
    fi

    if [[ -n "$env_value" ]]; then
      escaped_react_config_value=$(sed -E 's|/|\\/|g' <<<"${env_value}")
      # actually do the search and replace to add the js config to the html page
      sed -i "s/\(window.spiffworkflowFrontendJsenv *= *{}\)/\1;window.spiffworkflowFrontendJsenv.${env_var} = '${escaped_react_config_value}'/" "$index_html_file"

      env_value_grep_escaped=$(sed -E 's/\[/\\[/g' <<<"$env_value")
      if ! grep -q "${env_var} = '${env_value_grep_escaped}'" "$index_html_file"; then
        echo >&2 "ERROR: Could not find \"${env_var} = '${env_value}'\" in '${index_html_file}' after search and replace. It is likely that the assumptions in boot_server_in_docker about the contents of the html page have changed. Fix the glitch in boot_server_in_docker."
        echo >&2 "index.html: $(cat $index_html_file)"
        exit 1
      fi
    fi
  done <<<"$react_configs"
fi

port_to_use="${PORT0:-80}"
if [[ -n "${SPIFFWORKFLOW_FRONTEND_INTERNAL_PORT:-}" ]]; then
  port_to_use="$SPIFFWORKFLOW_FRONTEND_INTERNAL_PORT"
fi
sed "s/{{SPIFFWORKFLOW_FRONTEND_INTERNAL_PORT}}/${port_to_use}/g" /var/tmp/nginx.conf.template >/etc/nginx/conf.d/default.conf

exec nginx -g "daemon off;"
